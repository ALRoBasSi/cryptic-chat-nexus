
# دليل نظام الدردشة المشفر

## 🔍 نظرة عامة على طريقة عمل النظام

**نظام الدردشة المشفر** هو تطبيق ويب متكامل مبني على تقنيات الويب الكلاسيكية (PHP/MySQL/JavaScript) يتيح للمستخدمين التواصل عبر رسائل مشفرة في غرف محددة مع نظام صلاحيات كامل (RBAC).

### كيف يعمل النظام؟

1. **تسجيل الدخول والمصادقة**:
   - يبدأ المستخدم من صفحة تسجيل الدخول (index.php).
   - عند إدخال بيانات صحيحة، يتم التحقق منها مقابل قاعدة البيانات وإنشاء جلسة آمنة.
   - يتم توجيه المستخدم إلى الصفحة المناسبة حسب دوره (مسؤول/مستخدم عادي).

2. **نظام الدردشة**:
   - يمكن للمستخدمين الدخول إلى غرف الدردشة المصرح لهم بها.
   - الرسائل يتم تشفيرها قبل الحفظ في قاعدة البيانات وفك تشفيرها عند العرض.
   - تحديث الرسائل يتم بشكل مباشر عبر تقنية AJAX دون الحاجة لإعادة تحميل الصفحة.
   - قائمة المستخدمين النشطين تُحدث تلقائياً.

3. **لوحة تحكم المسؤول**:
   - تتيح للمسؤول إدارة المستخدمين والغرف والإطلاع على الإحصائيات.
   - يمكن إضافة وتعديل وحذف المستخدمين وتعيين أدوارهم.
   - يمكن إنشاء غرف جديدة وتعديل الصلاحيات على الغرف الموجودة.

## 🛠️ التقنيات المستخدمة في المشروع

### 1. PHP (الإصدار 7.4 أو أعلى)
- **معالجة الطلبات**: جميع الطلبات تُعالج بواسطة ملفات PHP.
- **الجلسات**: تُستخدم لتخزين معلومات المستخدم وحالة تسجيل الدخول.
- **نمط الكود**: يستخدم النمط الإجرائي Procedural مع تنظيم الدوال في ملفات منفصلة.
- **الأمان**: تنفيذ آليات للحماية ضد SQL Injection و XSS و CSRF.

### 2. MySQL
- **تخزين البيانات**: المستخدمين، الغرف، الرسائل، الإعدادات.
- **العلاقات**: علاقات بين الجداول باستخدام المفاتيح الأجنبية.
- **التشفير**: تخزين كلمات المرور مشفرة باستخدام bcrypt وتشفير الرسائل باستخدام AES-256.

### 3. HTML5 & CSS3
- **هيكل الصفحات**: تستخدم HTML5 لبناء هيكل الصفحات.
- **Bootstrap RTL**: إطار عمل لتصميم واجهة المستخدم مع دعم اللغة العربية (RTL).
- **التجاوب**: تصميم متجاوب يعمل على مختلف أحجام الشاشات.

### 4. JavaScript & AJAX
- **تفاعلات المستخدم**: التحقق من صحة المدخلات، تبديل عرض/إخفاء كلمة المرور.
- **AJAX**: لتحديث الرسائل والمستخدمين النشطين دون إعادة تحميل الصفحة.
- **معالجة الأحداث**: التعامل مع أحداث النقر والإرسال والتحديث.

### 5. تقنيات التشفير
- **تشفير كلمات المرور**: باستخدام `password_hash()` و `password_verify()`.
- **تشفير الرسائل**: باستخدام `openssl_encrypt()` و `openssl_decrypt()` بمعيار AES-256.
- **مفاتيح التشفير**: مفاتيح فريدة لكل غرفة تُخزن بشكل آمن.

## 🔐 نظام الصلاحيات (RBAC)

### الأدوار الرئيسية

1. **المسؤول (Admin)**:
   - الوصول الكامل إلى لوحة التحكم.
   - إدارة المستخدمين (إضافة، تعديل، حذف).
   - إدارة الغرف (إنشاء، تعديل، حذف).
   - تعيين الصلاحيات للمستخدمين على الغرف.
   - الاطلاع على جميع الإحصائيات والتقارير.

2. **المستخدم العادي (Client)**:
   - دخول الغرف المصرح له بها.
   - إرسال واستقبال الرسائل المشفرة.
   - تعديل الملف الشخصي وكلمة المرور.
   - عرض المستخدمين النشطين في الغرف.

### آلية التطبيق

- **جداول الصلاحيات**: جدول خاص بربط المستخدمين بالغرف وتحديد صلاحياتهم.
- **التحقق من الصلاحيات**: دوال PHP مثل `checkLogin()` و `checkAdmin()` و `canAccessRoom()`.
- **حماية الصفحات**: كل صفحة تتحقق من الصلاحيات المطلوبة قبل عرض المحتوى.

## 📂 هيكل المجلدات والملفات

```
/secure-chat-rbac/
│
├── index.php                     # صفحة البداية (تسجيل الدخول)
│
├── includes/                     # مجلد الملفات المشتركة
│   ├── config.php                # إعدادات الاتصال بقاعدة البيانات ومفاتيح التشفير
│   ├── auth_functions.php        # دوال المصادقة وإدارة الحسابات
│   ├── chat_functions.php        # دوال الدردشة وإدارة الغرف
│   ├── encryption_functions.php  # دوال التشفير وفك التشفير
│   ├── general_functions.php     # دوال عامة مساعدة
│   ├── admin_functions.php       # دوال خاصة بلوحة تحكم المسؤول
│   ├── admin_sidebar.php         # قالب القائمة الجانبية للمسؤول
│   └── chat_header.php           # قالب رأس صفحة الدردشة
│
├── api/                          # مجلد ملفات واجهة برمجة التطبيقات (API)
│   ├── get_new_messages.php      # API لجلب الرسائل الجديدة
│   ├── get_active_users.php      # API لجلب المستخدمين النشطين
│   └── send_message.php          # API لإرسال رسالة جديدة
│
├── assets/                       # مجلد الأصول الثابتة
│   ├── css/                      # أنماط CSS
│   ├── js/                       # ملفات JavaScript
│   └── images/                   # الصور والأيقونات
│
├── pages/                        # مجلد صفحات التطبيق
│   ├── admin/                    # صفحات المسؤول
│   │   ├── dashboard.php         # لوحة تحكم المسؤول
│   │   ├── users.php             # إدارة المستخدمين
│   │   ├── rooms.php             # إدارة الغرف
│   │   └── ...                   # باقي صفحات الإدارة
│   │
│   └── chat/                     # صفحات الدردشة للمستخدمين
│       ├── rooms.php             # قائمة الغرف المتاحة
│       ├── room.php              # غرفة دردشة محددة
│       └── profile.php           # الملف الشخصي للمستخدم
│
├── uploads/                      # مجلد الملفات المرفوعة (إذا تم تفعيل مشاركة الملفات)
│
└── backups/                      # مجلد النسخ الاحتياطية
```

## 🔄 روابط الربط بين الصفحات

### تدفق العمل الأساسي

1. **البداية**: `index.php` (صفحة تسجيل الدخول)
   - إذا كان المستخدم مسجل دخوله:
     - المسؤول → `pages/admin/dashboard.php`
     - المستخدم العادي → `pages/chat/rooms.php`

2. **المسار للمسؤول**:
   - `dashboard.php` → لوحة معلومات عامة مع روابط إلى:
     - `users.php` → إدارة المستخدمين
       - `user_add.php` → إضافة مستخدم جديد
       - `user_edit.php` → تعديل مستخدم موجود
     - `rooms.php` → إدارة الغرف
       - `room_add.php` → إنشاء غرفة جديدة
       - `room_edit.php` → تعديل غرفة موجودة
       - `room_users.php` → إدارة مستخدمي الغرفة

3. **المسار للمستخدم العادي**:
   - `rooms.php` → قائمة بالغرف المتاحة للمستخدم
     - `room.php?id=X` → الدخول إلى غرفة محددة
   - `profile.php` → عرض وتعديل الملف الشخصي

4. **الخروج**: جميع الصفحات تحتوي على رابط لـ `logout.php` الذي ينهي الجلسة ويعيد التوجيه إلى `index.php`.

## 🗃️ الربط مع قاعدة البيانات

### ملف الإعدادات - `includes/config.php`

```php
<?php
/**
 * ملف إعدادات النظام
 * يحتوي على معلومات الاتصال بقاعدة البيانات ومفاتيح التشفير
 */

// إعدادات قاعدة البيانات
define('DB_HOST', 'localhost');
define('DB_USERNAME', 'root');
define('DB_PASSWORD', '');
define('DB_NAME', 'secure_chat');
define('DB_CHARSET', 'utf8mb4');

// مفتاح التشفير الرئيسي للنظام (يجب تغييره في بيئة الإنتاج)
define('ENCRYPTION_KEY', 'Lkw4^8tMn@p61S#xQzVf!yC3g7Dj2E9a');

// إعدادات عامة
define('SITE_NAME', 'نظام الدردشة المشفر');
define('SITE_URL', 'http://localhost/secure-chat-rbac');

// إعدادات الجلسة
define('SESSION_NAME', 'secure_chat_session');
ini_set('session.cookie_httponly', 1);
ini_set('session.use_only_cookies', 1);
ini_set('session.cookie_secure', 0); // تعيين إلى 1 في بيئة HTTPS

// دالة الاتصال بقاعدة البيانات
function connectDB() {
    $connection = @mysqli_connect(DB_HOST, DB_USERNAME, DB_PASSWORD, DB_NAME);
    
    if (!$connection) {
        die('فشل الاتصال بقاعدة البيانات: ' . mysqli_connect_error());
    }
    
    mysqli_set_charset($connection, DB_CHARSET);
    
    return $connection;
}

// تعيين المنطقة الزمنية
date_default_timezone_set('Asia/Riyadh');
?>
```

### آلية الاتصال بقاعدة البيانات

1. **الاتصال**: يتم استدعاء دالة `connectDB()` للحصول على اتصال مع قاعدة البيانات.
2. **الاستعلامات الآمنة**: استخدام Prepared Statements لتنفيذ الاستعلامات بشكل آمن.
3. **إغلاق الاتصال**: يتم إغلاق الاتصال بعد الانتهاء من العمليات.

مثال على استخدام الاتصال:

```php
// استدعاء ملف التكوين للحصول على دالة الاتصال
require_once 'includes/config.php';

// إنشاء اتصال بقاعدة البيانات
$db = connectDB();

// استعلام آمن باستخدام Prepared Statement
$query = "SELECT * FROM users WHERE username = ?";
$stmt = mysqli_prepare($db, $query);
mysqli_stmt_bind_param($stmt, "s", $username);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);

// التعامل مع النتائج
while ($row = mysqli_fetch_assoc($result)) {
    // معالجة البيانات
}

// إغلاق الاستعلام والاتصال
mysqli_stmt_close($stmt);
mysqli_close($db);
```

## 🚀 تشغيل المشروع على الخادم المحلي

### المتطلبات الأساسية

1. **XAMPP/WAMP/MAMP**: تثبيت حزمة تشغيل تتضمن:
   - خادم ويب Apache
   - PHP (الإصدار 7.4 أو أعلى)
   - MySQL/MariaDB
   - phpMyAdmin

2. **متصفح ويب حديث**: Chrome, Firefox, Edge, Safari

### خطوات الإعداد والتشغيل

1. **تثبيت XAMPP**:
   - قم بتنزيل وتثبيت XAMPP من الموقع الرسمي: [https://www.apachefriends.org](https://www.apachefriends.org)
   - تأكد من تحديد مكونات Apache, MySQL, PHP, phpMyAdmin أثناء التثبيت.

2. **نسخ ملفات المشروع**:
   - قم بنسخ كامل مجلد المشروع `secure-chat-rbac` إلى مجلد `htdocs` داخل مجلد تثبيت XAMPP.
   - مثلاً: `C:\xampp\htdocs\secure-chat-rbac` (Windows) أو `/Applications/XAMPP/htdocs/secure-chat-rbac` (Mac).

3. **تشغيل الخدمات**:
   - افتح لوحة تحكم XAMPP.
   - قم بتشغيل خدمتي Apache و MySQL.

4. **إنشاء قاعدة البيانات**:
   - افتح متصفح ويب وانتقل إلى: `http://localhost/phpmyadmin`
   - قم بإنشاء قاعدة بيانات جديدة باسم `secure_chat`
   - استورد ملف `database_schema.sql` الموجود في جذر المشروع.

5. **ضبط إعدادات الاتصال**:
   - تحقق من ملف `includes/config.php` وتأكد من صحة معلومات الاتصال بقاعدة البيانات.
   - عدّل اسم المستخدم وكلمة المرور إذا كنت قد غيرتهما عن الإعدادات الافتراضية.

6. **الوصول إلى النظام**:
   - افتح المتصفح وانتقل إلى: `http://localhost/secure-chat-rbac`
   - ستظهر صفحة تسجيل الدخول.

7. **تسجيل الدخول**:
   - استخدم بيانات الاعتماد الافتراضية:
     - المسؤول: اسم المستخدم `admin` وكلمة المرور `admin123`
     - المستخدم العادي: اسم المستخدم `user` وكلمة المرور `user123`
   - **ملاحظة مهمة**: قم بتغيير كلمات المرور الافتراضية بعد أول تسجيل دخول.

## ⚠️ ملاحظات أمنية مهمة

1. **كلمات المرور**:
   - في بيئة الإنتاج، تأكد من تغيير مفتاح التشفير الرئيسي `ENCRYPTION_KEY`.
   - قم بتعيين سياسة قوية لكلمات المرور (8 أحرف على الأقل، أحرف كبيرة وصغيرة، أرقام، رموز).

2. **حماية الملفات**:
   - تأكد من وجود ملف `.htaccess` في المجلدات الحساسة لمنع الوصول المباشر.
   - ضع ملفات التكوين خارج المجلدات المتاحة للويب إن أمكن.

3. **التشفير**:
   - لا تتبع نفس مفتاح التشفير في جميع البيئات.
   - احفظ مفاتيح التشفير بشكل آمن وقم بتغييرها دورياً.

4. **النسخ الاحتياطي**:
   - قم بإنشاء نسخ احتياطية منتظمة لقاعدة البيانات.
   - احتفظ بنسخ احتياطية في مواقع مختلفة.

5. **التحديثات**:
   - حافظ على تحديث PHP ومكونات النظام باستمرار.
   - راقب الثغرات الأمنية في المكتبات المستخدمة.

## 📝 مصادر إضافية

- [توثيق PHP الرسمي](https://www.php.net/docs.php)
- [توثيق MySQL](https://dev.mysql.com/doc/)
- [توثيق Bootstrap](https://getbootstrap.com/docs/)
- [دليل أمان PHP](https://phpsecurity.readthedocs.io/en/latest/)
