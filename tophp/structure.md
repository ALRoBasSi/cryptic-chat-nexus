
# هيكل المشروع وتنظيم الملفات

**الوصف**: هذا الملف يوضح هيكل مجلدات وملفات نظام الدردشة المشفر بشكل كامل، ويشرح دور كل مجلد وملف.

## هيكل المجلدات الرئيسي

```
/secure-chat-rbac/
│
├── index.php                     # صفحة البداية (تسجيل الدخول)
├── database_schema.sql           # ملف إنشاء قاعدة البيانات
├── .htaccess                     # ملف إعدادات Apache
│
├── includes/                     # مجلد الملفات المشتركة
│   ├── config.php                # إعدادات الاتصال بقاعدة البيانات ومفاتيح التشفير
│   ├── auth_functions.php        # دوال المصادقة وإدارة الحسابات
│   ├── chat_functions.php        # دوال الدردشة وإدارة الغرف
│   ├── encryption_functions.php  # دوال التشفير وفك التشفير
│   ├── general_functions.php     # دوال عامة مساعدة
│   ├── admin_functions.php       # دوال خاصة بلوحة تحكم المسؤول
│   ├── admin_sidebar.php         # قالب القائمة الجانبية للمسؤول
│   └── chat_header.php           # قالب رأس صفحة الدردشة
│
├── api/                          # مجلد ملفات واجهة برمجة التطبيقات (API)
│   ├── get_new_messages.php      # API لجلب الرسائل الجديدة
│   ├── get_active_users.php      # API لجلب المستخدمين النشطين
│   └── send_message.php          # API لإرسال رسالة جديدة
│
├── assets/                       # مجلد الأصول الثابتة
│   ├── css/                      # أنماط CSS
│   │   ├── style.css             # أنماط عامة للموقع
│   │   ├── admin.css             # أنماط لوحة تحكم المسؤول
│   │   └── chat.css              # أنماط صفحات الدردشة
│   │
│   ├── js/                       # ملفات JavaScript
│   │   ├── chat.js               # وظائف الدردشة والتحديث المباشر
│   │   └── admin.js              # وظائف لوحة تحكم المسؤول
│   │
│   └── images/                   # الصور والأيقونات
│       ├── logo.png              # شعار النظام
│       └── avatar.png            # صورة افتراضية للمستخدم
│
├── pages/                        # مجلد صفحات التطبيق
│   ├── admin/                    # صفحات المسؤول
│   │   ├── dashboard.php         # لوحة تحكم المسؤول
│   │   ├── users.php             # إدارة المستخدمين
│   │   ├── user_add.php          # إضافة مستخدم جديد
│   │   ├── user_edit.php         # تعديل مستخدم
│   │   ├── rooms.php             # إدارة الغرف
│   │   ├── room_add.php          # إنشاء غرفة جديدة
│   │   ├── room_edit.php         # تعديل غرفة
│   │   ├── room_users.php        # إدارة مستخدمي الغرفة
│   │   ├── messages.php          # عرض وإدارة الرسائل
│   │   ├── settings.php          # إعدادات النظام
│   │   ├── backups.php           # إدارة النسخ الاحتياطية
│   │   ├── reports.php           # تقارير النظام
│   │   └── activities.php        # سجل النشاطات
│   │
│   └── chat/                     # صفحات الدردشة للمستخدمين
│       ├── rooms.php             # قائمة الغرف المتاحة
│       ├── room.php              # غرفة دردشة محددة
│       ├── profile.php           # الملف الشخصي للمستخدم
│       └── changePassword.php    # تغيير كلمة المرور
│
├── uploads/                      # مجلد الملفات المرفوعة (إذا تم تفعيل مشاركة الملفات)
│   └── .htaccess                 # ملف حماية المجلد
│
└── backups/                      # مجلد النسخ الاحتياطية
    └── .htaccess                 # ملف حماية المجلد
```

## شرح دور كل مجلد وملف

### الملفات الرئيسية

1. **index.php**
   - صفحة البداية التي تظهر للزوار
   - تحتوي على نموذج تسجيل الدخول
   - تقوم بتوجيه المستخدمين المسجلين إلى صفحاتهم المناسبة

2. **database_schema.sql**
   - ملف SQL لإنشاء قاعدة البيانات وهيكلها
   - يتضمن إنشاء جميع الجداول والعلاقات والبيانات الأولية

3. **.htaccess**
   - ملف إعدادات خادم Apache
   - يتحكم في إعادة التوجيه وأمان URL
   - يمنع الوصول المباشر لبعض المجلدات

### مجلد Includes

1. **config.php**
   - إعدادات الاتصال بقاعدة البيانات
   - تعريف الثوابت الأساسية للنظام
   - مفاتيح التشفير الرئيسية

2. **auth_functions.php**
   - دوال تسجيل الدخول والخروج
   - التحقق من صلاحيات المستخدمين
   - إدارة الجلسات (Sessions)

3. **chat_functions.php**
   - دوال إدارة غرف الدردشة
   - إرسال واستقبال الرسائل
   - إدارة المستخدمين في الغرف

4. **encryption_functions.php**
   - دوال تشفير وفك تشفير الرسائل
   - إدارة مفاتيح التشفير
   - دوال تشفير كلمات المرور

5. **general_functions.php**
   - دوال عامة مساعدة تستخدم في عدة أماكن
   - تنسيق البيانات والتواريخ
   - تنظيف المدخلات وحمايتها

6. **admin_functions.php**
   - دوال خاصة بلوحة تحكم المسؤول
   - إدارة المستخدمين والغرف
   - توليد التقارير والإحصائيات

7. **admin_sidebar.php** و **chat_header.php**
   - قوالب لأجزاء متكررة من صفحات النظام
   - تسهل إعادة استخدام نفس المكونات في عدة صفحات

### مجلد API

يحتوي على ملفات تستخدم لتوفير واجهة برمجة التطبيق (API) للتفاعل المباشر:

1. **get_new_messages.php**
   - يجلب الرسائل الجديدة في غرفة محددة
   - يستخدم للتحديث المباشر للدردشة عبر AJAX

2. **get_active_users.php**
   - يجلب قائمة المستخدمين النشطين في غرفة محددة
   - يستخدم لتحديث قائمة المستخدمين النشطين عبر AJAX

3. **send_message.php**
   - يستقبل ويحفظ الرسائل الجديدة
   - يشفر الرسائل قبل حفظها في قاعدة البيانات

### مجلد Assets

1. **css/**
   - أنماط التصميم للموقع
   - ملفات CSS المختلفة للأقسام المختلفة

2. **js/**
   - ملفات JavaScript للتفاعلات في الواجهة
   - وظائف AJAX لتحديث الدردشة بشكل مباشر

3. **images/**
   - الصور والأيقونات المستخدمة في النظام
   - الشعار وصور المستخدمين الافتراضية

### مجلد Pages

1. **admin/**
   - صفحات لوحة تحكم المسؤول
   - إدارة المستخدمين والغرف والإعدادات
   - عرض التقارير والإحصائيات

2. **chat/**
   - صفحات الدردشة للمستخدمين العاديين
   - عرض وإرسال الرسائل
   - الملف الشخصي وإعدادات الحساب

### مجلد Uploads

- مخصص للملفات المرفوعة إذا تم تفعيل ميزة مشاركة الملفات
- يحتوي على ملف `.htaccess` لحماية الملفات وتقييد الوصول

### مجلد Backups

- يحتوي على النسخ الاحتياطية لقاعدة البيانات
- محمي بملف `.htaccess` لمنع الوصول المباشر إليه

## ملفات .htaccess للحماية

### ملف .htaccess الرئيسي

```apache
# منع عرض محتويات المجلدات
Options -Indexes

# إعادة توجيه كل الطلبات إلى HTTPS (في بيئة الإنتاج)
# RewriteEngine On
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# منع الوصول إلى ملفات التكوين والدوال مباشرة
<FilesMatch "^(config\.php|.*_functions\.php)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# حماية ملف .htaccess نفسه
<Files .htaccess>
    Order Allow,Deny
    Deny from all
</Files>

# تعيين مدة صلاحية ملفات الوسائط الساكنة
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>
```

### ملف .htaccess لمجلد backups

```apache
# منع الوصول المباشر إلى جميع الملفات
Order Deny,Allow
Deny from all
```

### ملف .htaccess لمجلد uploads

```apache
# السماح بعرض الصور والملفات المسموح بها فقط
Order Deny,Allow
Deny from all

<FilesMatch "\.(jpg|jpeg|png|gif|pdf|doc|docx)$">
    Allow from all
</FilesMatch>

# منع تنفيذ ملفات PHP في مجلد التحميل
<FilesMatch "\.php$">
    Order Allow,Deny
    Deny from all
</FilesMatch>
```

## توزيع وتنظيم الملفات

1. **فصل المسؤوليات**:
   - فصل ملفات PHP عن ملفات CSS و JavaScript
   - فصل صفحات المسؤول عن صفحات المستخدم العادي
   - تجميع الدوال المرتبطة في ملفات منفصلة

2. **الأمان**:
   - ملفات التكوين والدوال خارج مجلد الويب العام
   - استخدام ملفات .htaccess لتقييد الوصول
   - حماية مجلدات النسخ الاحتياطية والتحميل

3. **قابلية التوسع**:
   - تنظيم منطقي يسمح بإضافة ميزات جديدة بسهولة
   - استخدام تضمين الملفات (include) لتجنب تكرار الكود
   - هيكل يدعم زيادة عدد المستخدمين والغرف
